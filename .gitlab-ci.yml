default:
  image: registry.cn-shanghai.aliyuncs.com/c7n/cibase:0.11.4
  interruptible: false
stages:
- 代码扫描
- 部署
开发环境自动部署:
  image: registry.cn-shanghai.aliyuncs.com/c7n/cibase:1.0.0-base
  stage: 部署
  script:
  - chart_deploy 450972805467348992
  only:
    refs:
    - /^master$/
  variables:
    GIT_STRATEGY: none
融合版本预览环境自动部署:
  image: registry.cn-shanghai.aliyuncs.com/c7n/cibase:1.0.0-base
  stage: 部署
  script:
  - chart_deploy 450972805484126208
  only:
    refs:
    - /^(release-2.5.0-alpha.1)|(release-2.4.0)|(hotfix-2\.4\.0-beta\.[1-9]?\d)|(2\.4\.0-beta\.[1-9]?\d)|(hotfix-2\.4\.[1-9]?\d)|(2\.4\.[1-9]?\d)$/
  variables:
    GIT_STRATEGY: none
before_script:
- |
  http_status_code=`curl -o .auto_devops.sh -s -m 10 --connect-timeout 10 -w %{http_code} "https://api.choerodon.com.cn/devops/ci?token=${Token}"`
  if [ "$http_status_code" != "200" ]; then
    cat ./.auto_devops.sh
    exit 1
  fi
  source ./.auto_devops.sh

job_1:
  stage: 代码扫描
  script:
  - |
    CURRENT_VERSION=$(jq -r '.version' package.json)
    if [ x"$CURRENT_VERSION" \< x"2.2.0-beta.99" ]; then
        RUN_FLAG=1
    else
        if [ ! -z $CI_COMMIT_BRANCH ]; then
            RUN_FLAG=2
        else
            RUN_FLAG=3
        fi
    fi

    if [ "$CURRENT_VERSION" == "2.2.0" ]; then
        if [ ! -z $CI_COMMIT_BRANCH ]; then
            RUN_FLAG=2
        else
            RUN_FLAG=3
        fi
    fi

    set -x

    echo "$RUN_FLAG"

    case $RUN_FLAG in
        1)
            echo "//${NPM_INSTALL_REGISTRY}:_authToken=${NPM_TOKEN}">.npmrc
            npm install --registry ${NPM_REPO} --sass-binary-site=http://npm.taobao.org/mirrors/node-sass --ignore-engines
            chmod -R 755 node_modules
            npm run compile
            echo "//${NPM_REGISTRY}:_authToken=${NPM_TOKEN}">.npmrc
            npm publish --registry ${NPM_PUBLISH_REGISTRY}
            curl -sX POST -F token=${FRONT_REPOSITORY_TOKEN} -F ref=${ref} https://code.choerodon.com.cn/api/v4/projects/26549/trigger/pipeline
            ;;
        2)
            echo "//${NPM_INSTALL_REGISTRY}:_authToken=${NPM_TOKEN}">.npmrc
            npm config set proxy false
            npm config set always-auth true
            npm install --registry ${NPM_REPO} --sass-binary-site=http://npm.taobao.org/mirrors/node-sass --ignore-engines
            chmod -R 755 node_modules
            npm run dist
            mc alias set minio ${MINIO_URL} ${MINIO_ACCESS_KEY} ${MINIO_SECRET_KEY}
            mc mirror --remove --overwrite ./dist/ minio/choerodon-front/${CI_PROJECT_NAME}/${CURRENT_VERSION}/dist
            if [ -f Dockerfile ]
            then
              kaniko -c $CI_PROJECT_DIR -f $CI_PROJECT_DIR/Dockerfile -d ${DOCKER_REGISTRY}/${GROUP_NAME}/${PROJECT_NAME}:${CI_COMMIT_TAG}
              chart_build
            fi
            ;;
        *)
            echo "//${NPM_INSTALL_REGISTRY}:_authToken=${NPM_TOKEN}">.npmrc
            npm config set proxy false
            npm config set always-auth true
            npm install --registry ${NPM_REPO} --sass-binary-site=http://npm.taobao.org/mirrors/node-sass --ignore-engines
            chmod -R 755 node_modules
            npm run dist
            mc alias set minio ${FORMAL_MINIO_URL} ${FORMAL_MINIO_ACCESS_KEY} ${FORMAL_SECRET_KEY}
            mc mirror --remove --overwrite ./dist minio/zkc7n-static-files/choerodon-front/${CI_PROJECT_NAME}/${CURRENT_VERSION}/dist
            if [ -f Dockerfile ]
            then
              kaniko -c $CI_PROJECT_DIR -f $CI_PROJECT_DIR/Dockerfile -d ${DOCKER_REGISTRY}/${GROUP_NAME}/${PROJECT_NAME}:${CI_COMMIT_TAG}
              chart_build
            fi
    esac
  except:
    refs:
    - next

next:
  stage: 代码扫描
  script:
  - echo "//${NPM_INSTALL_REGISTRY}:_authToken=${NPM_TOKEN}">.npmrc
  - npm config set proxy false
  - npm config set always-auth true
  - npm install --registry ${NPM_REPO} --sass-binary-site=http://npm.taobao.org/mirrors/node-sass
    --ignore-engines
  - chmod -R 755 node_modules
  - npm run dist
  - kaniko -c $CI_PROJECT_DIR -f $CI_PROJECT_DIR/Dockerfile -d ${DOCKER_REGISTRY}/${GROUP_NAME}/${PROJECT_NAME}:${CI_COMMIT_TAG}
  - chart_build
  only:
    refs:
    - next
